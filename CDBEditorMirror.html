<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CDB JSON Editor – Dark Mode (Auto Save)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<!-- CodeMirror 6 CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>

<style>
  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: #121212;
    color: #e0e0e0;
    margin: 20px;
  }
  h1 { color: #bb86fc; margin-top: 0; }
  .controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 1.2rem 0;
    align-items: center;
    position: relative;
  }
  .save-status {
    position: absolute;
    right: 10px;
    font-size: 0.9rem;
    color: #4caf50;
    opacity: 0;
    transition: opacity 0.4s;
  }
  .save-status.show { opacity: 1; }
  .save-status.error { color: #f44336; }
  input, select, button {
    padding: 9px 14px;
    background: #1e1e1e;
    border: 1px solid #444;
    color: #e0e0e0;
    border-radius: 6px;
  }
  input::placeholder { color: #888; }
  select option { background: #1e1e1e; color: #e0e0e0; }
  .split {
    display: flex;
    gap: 20px;
    max-height: 82vh;
    position: relative;
  }
  #itemList {
    width: 360px;
    overflow-y: auto;
    background: #1e1e1e;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    padding: 8px;
  }
  #editor {
    flex: 1;
    overflow-y: auto;
    background: #1e1e1e;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    padding: 16px;
  }
  #rawJson {
    width: 460px;
    min-width: 320px;
    max-width: 60vw;
    overflow-y: auto;
    background: #1e1e1e;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    padding: 16px;
    display: none;
    resize: horizontal;           /* ← allows user to resize */
    overflow: hidden;             /* prevents scrollbars from resize */
  }
  #rawJson.visible { display: flex; flex-direction: column; }
  #rawEditorContainer {
  flex: 1;
  min-height: 800px;   /* ← try 800–1000px or even 70vh */
  height: 100%;
  border: 1px solid #444;
  border-radius: 4px;
  overflow: hidden;
  background: #252525;
}
  /* ─────────────────────────────────────────────── */
/* SUPER FORCE dark theme – no white survives       */
/* ─────────────────────────────────────────────── */
.cm-editor,
.cm-editor *,
.cm-scroller,
.cm-content,
.cm-gutters,
.cm-line,
.cm-s-default,
.CodeMirror,
.CodeMirror-scroll,
.CodeMirror pre,
.CodeMirror-linenumber {
  background-color: #252525;
  background: #252525;
  color: #e0e0e0;
}

/* Gutter (line numbers) */
.cm-gutters,
.cm-gutter {
  background-color: #1e1e1e !important;
  color: #888 !important;
  border-right: 1px solid #333 !important;
}

/* Prevent any light fallback */
.cm-editor .CodeMirror-gutters,
.cm-editor .cm-line-background,
.cm-editor .cm-selectionBackground {
  background: #252525 !important;
}

/* Syntax highlighting (keep or change colors as you like) */
.cm-keyword        { color: #c678dd !important; }
.cm-string         { color: #98c379 !important; }
.cm-number         { color: #d19a66 !important; }
.cm-property       { color: #e06c75 !important; }
.cm-punctuation    { color: #abb2bf !important; }

  .item { padding: 10px 12px; margin: 4px 0; cursor: pointer; border-radius: 6px; transition: all 0.13s; background: #252525; }
  .item:hover { background: #333; }
  .item.selected { background: #3700b3; border-left: 4px solid #bb86fc; }
  .item .id { color: #bb86fc; font-family: monospace; }
  .item .cat { color: #a0a0a0; font-size: 0.9em; }
  .field { margin: 14px 0; padding-left: 16px; border-left: 3px solid #444; }
  label { font-weight: 600; color: #e0e0e0; margin-bottom: 6px; display: block; }
  input, textarea, select {
    width: 100%;
    padding: 9px;
    background: #252525;
    border: 1px solid #444;
    color: #e0e0e0;
    border-radius: 6px;
    box-sizing: border-box;
  }
  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #bb86fc;
    box-shadow: 0 0 0 2px rgba(187,134,252,0.25);
  }
  .no-items { padding: 40px 20px; color: #888; font-style: italic; text-align: center; }
  button {
    padding: 9px 18px;
    background: #6200ee;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.95rem;
  }
  button:hover:not(:disabled) { background: #7c4dff; }
  button:disabled { background: #444; cursor: not-allowed; }
</style>
</head>
<body>

<h1>CDB JSON Editor – Dark Mode (Auto Save)</h1>

<div class="controls">
  <input type="file" id="fileInput" accept=".json" />
  <input type="text" id="searchInput" placeholder="Search _id / category / name…" />
  <select id="categoryFilter">
    <option value="">All Categories</option>
  </select>
  <button id="initialSaveBtn" disabled>Choose save location</button>
  <button id="toggleRawBtn">Show Raw JSON</button>
  <div id="saveStatus" class="save-status">Saved</div>
</div>

<div class="split">
  <div id="itemList">
    <div class="no-items">Load your JSON file to begin</div>
  </div>
  <div id="editor">
    <div class="no-items">← Select an item to edit its values</div>
  </div>
  <div id="rawJson">
    <label>Raw JSON (editable – changes auto-save)</label>
    <div id="rawEditorContainer"></div>
  </div>
</div>

<script>
let jsonData = null;
let selectedIndex = -1;
let currentSearch = '';
let currentCategory = '';
let fileHandle = null;
let originalFileName = 'edited_cdb_dark.json';
let hasChosenLocation = false;
let rawEditor = null;

const fileInput = document.getElementById('fileInput');
const searchInput = document.getElementById('searchInput');
const catFilter = document.getElementById('categoryFilter');
const itemListEl = document.getElementById('itemList');
const editorEl = document.getElementById('editor');
const initialSaveBtn = document.getElementById('initialSaveBtn');
const toggleRawBtn = document.getElementById('toggleRawBtn');
const saveStatus = document.getElementById('saveStatus');
const rawJsonPanel = document.getElementById('rawJson');
const rawContainer = document.getElementById('rawEditorContainer');

fileInput.onchange = loadFile;
searchInput.oninput = debounce(filterList, 280);
catFilter.onchange = filterList;
initialSaveBtn.onclick = chooseSaveLocation;
toggleRawBtn.onclick = toggleRawPanel;

function toggleRawPanel() {
  rawJsonPanel.classList.toggle('visible');
  toggleRawBtn.textContent = rawJsonPanel.classList.contains('visible') 
    ? "Hide Raw JSON" 
    : "Show Raw JSON";

  if (rawJsonPanel.classList.contains('visible') && !rawEditor) {
    initRawEditor();
  }
}

function initRawEditor() {
  rawEditor = CodeMirror(rawContainer, {
    value: selectedIndex !== -1 ? JSON.stringify(jsonData[selectedIndex], null, 2) : '',
    mode: 'application/json',
    lineNumbers: true,
    indentWithTabs: true,
    tabSize: 2,
    indentUnit: 2,
    viewportMargin: 10,
  });

  rawEditor.on('change', debounce(() => {
    try {
      const newValue = rawEditor.getValue();
      const parsed = JSON.parse(newValue);
      jsonData[selectedIndex] = parsed;
      renderEditor(parsed, '', editorEl);
      autoSave();
      showStatus("Raw edit saved", "success");
    } catch (e) {
      showStatus("Invalid JSON", "error");
    }
  }, 600));
}

async function loadFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.handle) fileHandle = file.handle;
  originalFileName = file.name || 'edited_cdb_dark.json';
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      jsonData = JSON.parse(ev.target.result);
      if (!Array.isArray(jsonData)) throw new Error("Not an array");
      populateCategories();
      filterList();
      initialSaveBtn.disabled = false;
      if (rawEditor) updateRawJsonDisplay();
    } catch(err) {
      alert("Invalid JSON:\n" + err.message);
    }
  };
  reader.readAsText(file);
}

async function chooseSaveLocation() {
  if (!jsonData) return;
  try {
    fileHandle = await window.showSaveFilePicker({
      suggestedName: originalFileName,
      types: [{
        description: 'JSON Files',
        accept: { 'application/json': ['.json'] },
      }],
    });
    hasChosenLocation = true;
    initialSaveBtn.textContent = "Location set ✓";
    initialSaveBtn.disabled = true;
    showStatus("Location set", "success");
  } catch (err) {
    if (err.name !== 'AbortError') {
      showStatus("Location failed", "error");
    }
  }
}

async function autoSave() {
  if (!jsonData || !hasChosenLocation || !fileHandle) return;
  try {
    const writable = await fileHandle.createWritable();
    await writable.write(JSON.stringify(jsonData, null, 2));
    await writable.close();
    showStatus("Saved", "success");
  } catch (err) {
    console.error("Auto-save failed:", err);
    showStatus("Save failed", "error");
  }
}

function showStatus(message, type = "success") {
  saveStatus.textContent = message;
  saveStatus.className = "save-status show " + (type === "error" ? "error" : "");
  setTimeout(() => {
    saveStatus.classList.remove("show");
  }, 1500);
}

function populateCategories() {
  const cats = new Set(jsonData.map(o => o.category).filter(Boolean));
  catFilter.innerHTML = '<option value="">All Categories</option>' +
    [...cats].sort().map(c => `<option value="${c}">${c}</option>`).join('');
}

function filterList() {
  currentSearch = searchInput.value.trim().toLowerCase();
  currentCategory = catFilter.value;
  itemListEl.innerHTML = '';
  const filtered = jsonData
    .map((item,i) => ({item,i}))
    .filter(({item}) => {
      if (currentCategory && item.category !== currentCategory) return false;
      if (!currentSearch) return true;
      const text = [
        item._id || '',
        item.category || '',
        (item.name?.text || '').toLowerCase(),
        String(item.block_id || ''),
        (item.description?.text || '').toLowerCase()
      ].join(' ');
      return text.includes(currentSearch);
    });
  if (filtered.length === 0) {
    itemListEl.innerHTML = '<div class="no-items">No matching items</div>';
    return;
  }
  filtered.forEach(({item,i}) => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="id">${item._id || '—'}</div>
      <div class="cat">${item.category || '—'}</div>
    `;
    div.onclick = () => selectItem(i);
    itemListEl.appendChild(div);
  });
}

function selectItem(idx) {
  selectedIndex = idx;
  document.querySelectorAll('.item').forEach(el=>el.classList.remove('selected'));
  const selected = [...document.querySelectorAll('.item')].find(el =>
    el.textContent.includes(jsonData[idx]._id || ''));
  if (selected) selected.classList.add('selected');
  renderEditor(jsonData[idx], '', editorEl);
  updateRawJsonDisplay();
}

function renderEditor(obj, path = '', container) {
  container.innerHTML = '';
  for (const [key, val] of Object.entries(obj)) {
    const currentPath = path ? `${path}.${key}` : key;
    const field = document.createElement('div');
    field.className = 'field';
    const label = document.createElement('label');
    label.textContent = key;
    field.appendChild(label);
    if (val === null) {
      const inp = document.createElement('input');
      inp.value = 'null';
      inp.disabled = true;
      field.appendChild(inp);
    }
    else if (Array.isArray(val)) {
      const arrInfo = document.createElement('div');
      arrInfo.textContent = `Array (${val.length} items)`;
      arrInfo.style.fontStyle = 'italic';
      arrInfo.style.color = '#aaa';
      field.appendChild(arrInfo);
      val.forEach((item, i) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'array-item';
        renderEditor({[`[${i}]`]: item}, currentPath, itemDiv);
        field.appendChild(itemDiv);
      });
    }
    else if (typeof val === 'object') {
      renderEditor(val, currentPath, field);
    }
    else {
      let input;
      if (typeof val === 'boolean') {
        input = document.createElement('select');
        input.innerHTML = `
          <option value="true" ${val ? 'selected' : ''}>true</option>
          <option value="false" ${!val ? 'selected' : ''}>false</option>
        `;
      } else if (typeof val === 'number') {
        input = document.createElement('input');
        input.type = 'number';
        input.step = 'any';
        input.value = val;
      } else {
        input = document.createElement(
          String(val).length > 60 ? 'textarea' : 'input'
        );
        if (input.tagName === 'TEXTAREA') input.rows = 3;
        input.value = val;
      }
      input.dataset.path = currentPath;
      input.onchange = () => {
        updateValue(currentPath, input.value);
        autoSave();
        updateRawJsonDisplay();
      };
      field.appendChild(input);
    }
    container.appendChild(field);
  }
}

function updateValue(path, newValueStr) {
  const parts = path.split('.');
  let current = jsonData[selectedIndex];
  for (let i = 0; i < parts.length - 1; i++) {
    let part = parts[i];
    if (part.startsWith('[') && part.endsWith(']')) {
      current = current[parseInt(part.slice(1,-1))];
    } else {
      current = current[part];
    }
  }
  const last = parts[parts.length-1];
  let key = last;
  if (last.startsWith('[') && last.endsWith(']')) {
    key = parseInt(last.slice(1,-1));
  }
  current[key] = parseValue(newValueStr);
}

function parseValue(str) {
  str = str.trim();
  if (str === 'true') return true;
  if (str === 'false') return false;
  if (str === 'null') return null;
  if (!isNaN(str) && str !== '') return Number(str);
  return str;
}

function updateRawJsonDisplay() {
  if (selectedIndex === -1 || !rawEditor) return;

  const jsonStr = JSON.stringify(jsonData[selectedIndex], null, 2);
  const current = rawEditor.getValue();

  if (current !== jsonStr) {
    const cursor = rawEditor.getCursor();
    rawEditor.setValue(jsonStr);
    rawEditor.setCursor(cursor);
    rawContainer.style.background = '#3700b330';
    setTimeout(() => rawContainer.style.background = '', 800);
  }
}

function debounce(fn, ms) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), ms);
  };
}
</script>
</body>
</html>